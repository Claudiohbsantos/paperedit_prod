import*as utils from"./utils.js";import player from"./player.js";import editor from"./quill.js";import{userSettings as settings}from"./userSettings.js";class Transcript{constructor(t){this.title="",this.ext={},this.ext.player=t.player,this.ext.editor=t.editor,this.timestampStringPattern=t.timestampPattern,this.timestampMatcher=new RegExp(t.timestampPattern,"g"),this.timestampPattern=new RegExp("^"+t.timestampPattern+"$"),this.sections=[],this.queue=new SectionQueue,this.strikedTime=0,this.exportTimeFormat={seconds:this.exportSecs,timestamp:this.exportTimestamp,timecode:this.exportTimecode},document.getElementById("hidden-ppcutinput").addEventListener("change",t=>{this.getPapercutFile(t)}),document.addEventListener("loadaudio-end",()=>this.recreateRegions())}exportSecs(t){return t}exportTimestamp(t){return utils.tsFromSeconds(t)}exportTimecode(t){return utils.tcFromSeconds(t,settings.framerate)}getEditTime(){if(this.ext.player.duration<=0)return 0;let t=0;for(let e of this.sections)e&&!e.isStriked()&&(t+=e.duration);return t}getSection(t){if(this.sections[t])return this.sections[t];let e=this.sections.slice(0,Math.floor(t)+1);for(let t=e.length;t>=0;t--)if(e[t])return this.sections[t]}getPreviousSection(t){let e=this.sections.slice(0,t),i=null;for(let t=e.length-1;t>=0;t--)if(e[t]){i=e[t];break}return i}getNextSection(t){let e=this.sections.slice(t+1),i=null;for(let t of e)if(t){i=t;break}return i}createSection(t,e,i){if(!t&&0!=t)throw new Error("tried to create timestamp without time");return this.sections[t]?null:(this.sections[t]=new Section(this,t,e,i,this.ext),this.sections[t])}removeSection(t){if(!this.sections[t])return;this.sections[t].removeRegion(),delete this.sections[t];let e=this.getSection(t);e&&e.updateRegion();let i=new CustomEvent("section-deleted",{bubbles:!0,detail:{time:t}});this.ext.editor.containerElement.dispatchEvent(i)}removeAllSections(){for(let t of this.sections)t&&this.removeSection(t.time)}getSectionAtIndex(t){if(!t)return null;let e=this.ext.editor.getLineInfo(t),i=this.ext.editor.quill.getContents().slice(e.index,t),s=null;for(let t=i.ops.length-1;t>=0;t--)if(i.ops[t].attributes&&i.ops[t].attributes.timestamp){s=i.ops[t].attributes.timestamp;break}return s&&s.time?this.sections[s.time]:null}getSectionsInLine(t){let e=this.ext.editor.getLineInfo(t);return this.ext.editor.quill.getContents().slice(e.index,e.index+e.length).ops.filter(t=>t.attributes&&t.attributes.timestamp).map(t=>this.getSection(t.attributes.timestamp.time))}getSectionsInCoordinateRange(t,e){let i=[],s=t+e;for(let e of this.sections){if(!e)continue;let n=e.getIndex(),r=this.ext.editor.quill.getBounds(n,e.line.length);if((r.top>=t&&r.top<s||r.bottom>=t&&r.bottom<s)&&i.push(e),r.top>s)break}return i}getSectionsAffectedByIndex(t){let e=this.getSectionAtIndex(t);return e?[e]:this.getSectionsInLine(t)}getStrikes(){return this.sections.filter(t=>t.isStriked()).map(t=>[t.time,t.endTime])}recreateRegions(){for(let t of this.sections)t&&this.queue.add(()=>{t.updateRegion()})}getTranscript(t){let e=t?this.exportSecs:this.exportTimeFormat[settings.exportTimeFormat],i=[];for(let t of this.sections)t&&i.push({start:e.apply(this,[t.time+settings.exportOffset]),name:t.name,end:e.apply(this,[t.endTime+settings.exportOffset]),line:t.line,striked:t.isStriked(),toRemove:t.toRemove()});return i}getPapercut(){return JSON.stringify({delta:this.ext.editor.quill.getContents(),audioFile:this.ext.player.filename,title:this.title})}importPapercut(){document.getElementById("hidden-ppcutinput").click()}getPapercutFile(t){let e=t.target.files[0];e.name.match(/\.ppcut$/i)?(this.loadPapercutFile(e),document.getElementById("hidden-ppcutinput").value=""):utils.showWarning(e.name+' is not a paperedit file. Paperedit project files end in ".ppcut"')}loadPapercutFile(t){let e=new FileReader;const i=this;e.onload=function(t){let e=JSON.parse(t.target.result);i.loadPapercut(e)},e.readAsText(t)}loadPapercut(t){this.removeAllSections(),document.dispatchEvent(new CustomEvent("papercutLoaded",{detail:t})),editor.quill.setContents(t.delta,"user");let e=document.getElementById("title-input");e.value=t.title||"",e.dispatchEvent(new Event("change")),this.saveLocalPapercut()}saveLocalPapercut(){let t=this.getPapercut();localStorage.setItem("papercut",t)}}class SectionQueue{constructor(){this.q=[]}add(t){this.q.push(t)}start(){this.timer=window.setInterval(t=>{for(;t.length>0;)setTimeout(t.shift(),0)},250,this.q)}runNow(){for(window.clearInterval(this.timer);this.q.length>0;)setTimeout(this.q.shift(),0);this.start()}}class Section{constructor(t,e,i,s,n){this.timestamp=new Timestamp(e,i,n),this.line="",this.transcript=t,this.ext=n,this.update()}get time(){return this.timestamp.time}get endTime(){let t=this.nextSection();return t?t.time:this.ext.player.getDuration()}get duration(){return this.endTime-this.time}getIndex(){return this.timestamp.getIndex()+this.timestamp.text.length}seekTo(){this.timestamp.seekTo()}goTo(){this.ext.editor.quill.setSelection(this.getIndex())}update(){this.transcript.queue.add(()=>{this.getLine()}),this.transcript.queue.add(()=>{this.getName()}),this.transcript.queue.add(()=>{this.updateRegion()})}getName(t){t=t||this.timestamp.getIndex();let e=this.ext.editor.getLineInfo(t),i=this.ext.editor.quill.getContents().slice(e.index,t),s="";for(let t=0,e=i.ops.length-1;t<=e&&(!i.ops[t].attributes||!i.ops[t].attributes.timestamp);t++)s+=i.ops[t].insert;return this.name=s.trim(),this.name}nextSection(){return this.transcript.getNextSection(this.time)}createRegion(){if(!player.hasOwnProperty("wavesurfer"))return;if(0==this.getLineOps().length)return;let t="#58BF56";this.isStriked()?t="#F87070":this.toRemove().length>0&&(t="#6169D9"),this.region=this.ext.player.addCustomRegion({start:this.time,end:this.endTime,type:"section",color:t}),this.emitRegionChangedEvent()}removeRegion(){this.region&&this.region.remove()}updateRegion(){this.removeRegion(),this.createRegion()}emitRegionChangedEvent(){const t=new CustomEvent("region-changed",{bubbles:!0,detail:{editTime:this.transcript.getEditTime()}});this.region.element.dispatchEvent(t)}getLineOps(){let t=this.getIndex(),e=this.ext.editor.getLineInfo(t),i=this.ext.editor.quill.getContents().slice(t,e.endIndex-1),s=[];for(let t of i.ops){if(t.attributes&&t.attributes.timestamp)break;(s.length>0||0==s.length&&!/^[\s]+$/.test(t.insert))&&s.push(t)}for(let t=s.length-1;t>=0&&/^\s+$/.test(s[t].insert);t--)s.pop();return s[0]&&(s[0].insert=s[0].insert.trimStart()),s[s.length-1]&&(s[s.length-1].insert=s[s.length-1].insert.trimEnd()),s}getLineRange(){let t,e=this.nextSection();e&&(t=e.timestamp.getIndex());let i=this.ext.editor.getLineInfo(this.getIndex()).endIndex,s=this.getIndex();return{index:s,length:t?Math.min(t,i)-s:i-s}}getLine(){return this.line=this.getLineOps().reduce((t,e)=>t+e.insert,""),this.line}isStriked(){let t=this.getLineOps();return t.length>0&&t.every(t=>!/\w/.test(t.insert)||t.attributes&&t.attributes.strike)}toRemove(){return this.isStriked()?[]:this.getLineOps().filter(t=>t.attributes&&t.attributes.strike).map(t=>t.insert.trim())}select(){let t=this.getIndex();this.ext.editor.quill.setSelection(t);let e=this.ext.editor.quill.getBounds(t,this.line.length);this.ext.editor.containerElement.scrollTop=e.top-(this.ext.editor.bounds.height-e.height)/2+this.ext.editor.yOffset}}class Timestamp{constructor(t,e,i){this.time=t,this.id="timestamp-"+t,this.text=e,this.ext=i}getIndex(){let t=this.ext.editor.quill.getContents(),e=t.ops.findIndex(t=>t.attributes&&t.attributes.timestamp&&t.attributes.timestamp.time==this.time);return e<0?null:t.ops.slice(0,e).reduce((t,e)=>t+this.ext.editor.getOpLength(e),0)}goTo(){this.ext.editor.quill.setSelection(this.getIndex())}seekTo(){this.ext.player.seekToSec(this.time)}}const transcriptInstance=new Transcript({timestampPattern:"\\[\\d\\d:\\d\\d:\\d\\d\\]",editor:editor,player:player});export default transcriptInstance;