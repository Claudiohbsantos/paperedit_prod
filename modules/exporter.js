import player from"./player.js";import paperedit from"../modules/transcript.js";import*as utils from"./utils.js";import createBuffer from"./buffers.js";import{show as exportProgress}from"../components/exportProgress.js";function generateFilename(){return paperedit.title||"paperedit"}export function exportPlainTextFile(e,r,t){let o=new Blob([e]);downloadFileURL(window.URL.createObjectURL(o),t?t+r:generateFilename()+r)}function getWebWorker(e){switch(e){case"wavencoder-worker.js":return new Worker("/modules/wavencoder-worker.js");case"mp3encoder-worker.js":return new Worker("/modules/mp3encoder-worker.js")}}export function exportAudioFile(e,r){if(player.backend&&player.backend.buffer)if(paperedit.getEditTime()<=0)utils.showWarning("exported audio would be empty. Make sure there are unstriked sections on the paperedit.");else if(window.Worker){let t=paperedit.getTranscript(!0),o=createBuffer(player.backend.buffer,t);const n=getWebWorker(e);showExportProgress(n,r.replace(".","")).then(e=>{let r={dialId:e,array:o.getChannelData(0),sampleRate:o.sampleRate};n.postMessage(r,[r.array.buffer])}).catch(e=>console.log(e)),n.onmessage=e=>{downloadFileURL(URL.createObjectURL(e.data.blob),generateFilename()+r),document.getElementById(e.data.dialId).dispatchEvent(new CustomEvent("export-finished")),e.target.terminate()}}else utils.showWarning("Your browser doesn't seem to support web workers. Please update browser.");else utils.showWarning("There doesn't seem to be any audio loaded. Export aborted")}function showExportProgress(e,r){return new Promise((t,o)=>{t(exportProgress(e,r))})}function downloadFileURL(e,r){var t=document.createEvent("MouseEvents"),o=document.createElement("a");o.download=r,o.href=e,t.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(t)}