import*as utils from"./utils.js";import player from"./player.js";import editor from"./quill.js";import paperedit from"./transcript.js";export function parseTimestamps(t,e,i){if("user"!==i)return;let m=editor.getAffectedOps(t,e);autoFormatTimestamps(m,t,e,i),updateSection(m)}function updateSection(t){const e=editor.quill.getSelection();let i=t.slice();e&&i.push(editor.getLeafInfo(e.index));let m=utils.removeDuplicateObjects(i,"index");for(let t of m){paperedit.getSectionsAffectedByIndex(t.index).forEach(t=>{t&&t.update()})}}function autoFormatTimestamps(t,e,i){checkDeletionsForTimestamps(e,i),t.forEach(t=>{checkTimestampIntegrity(t),checkLeafForTimestamps(t)})}function checkDeletionsForTimestamps(t,e){if(t.ops.some(t=>t.delete)){let i=editor.invertDelta(t,e),m=0;i.ops.forEach(t=>{if(t.attributes&&t.attributes.timestamp){checkForDeletedTimestamp(t),checkTimestampIntegrity(editor.getLeafInfo(m))}m+=editor.getOpLength(t)})}}function checkLeafForTimestamps(t){if(!t.text)return;let e=paperedit.timestampMatcher;setTimeout((t,e)=>{for(const i of t.text.matchAll(e)){let e=i[0],m=utils.secondsFromTC(e),r=i.index+t.index,o=paperedit.createSection(m,e,r);if(o){let t=editor.quill.getFormat(r,e.length);t.color&&"#ed0000"===t.color&&editor.quill.formatText(r,e.length,"color",!1,"timestamp_autoformat"),editor.quill.formatText(r,e.length,"timestamp",{time:o.time,id:o.timestamp.id},"timestamp_autoformat"),document.getElementById(o.timestamp.id).addEventListener("click",()=>player.seekToSec(o.time))}else editor.quill.formatText(r,e.length,"timestamp",!1,"timestamp_autoformat"),editor.quill.formatText(r,e.length,"color","#ed0000","timestamp_autoformat"),utils.showWarning("Duplicate Timestamp")}},0,t,e)}function checkForDeletedTimestamp(t){if(!t.insert)return;paperedit.timestampPattern.test(t.insert)&&t.attributes&&t.attributes.timestamp&&paperedit.removeSection(t.attributes.timestamp.time)}function checkTimestampIntegrity(t){if(!t.text)return;let e=paperedit.timestampPattern;t.formats&&t.formats.timestamp&&!e.test(t.text)&&(paperedit.removeSection(t.formats.timestamp.time),editor.quill.formatText(t.index,t.length,"timestamp",!1,"timestamp_integrityCheck"))}