import*as utils from"./utils.js";var Delta=Quill.import("delta");let Inline=Quill.import("blots/inline");class Editor{constructor(){this.containerElement=document.getElementById("editor-container"),this.yOffset=parseInt(window.getComputedStyle(document.documentElement).getPropertyValue("--headerHeight")),this.bounds=this.containerElement.getBoundingClientRect()}defineBlots(){class e extends Inline{static create(e){let t=super.create();return t.setAttribute("id",e.id),t.setAttribute("data-timestamp",e.time),t}static formats(e){return{id:e.getAttribute("id"),time:e.getAttribute("data-timestamp")}}}e.blotName="timestamp",e.tagName="timestamp",Quill.register(e)}defineMatchers(){return[[Node.ELEMENT_NODE,function(e,t){let n={};"line-through"===e.style["text-decoration-line"]&&(n.strike=!0);"underline"===e.style["text-decoration-line"]&&(n.underline=!0);return t.compose((new Delta).retain(t.length(),n))}]]}init(){this.defineBlots();let e=this.defineMatchers();this.quill=new Quill("#quill-container",{scrollingContainer:this.containerElement,bounds:this.containerElement,modules:{toolbar:"#toolbar-container",clipboard:{matchers:e},history:{userOnly:!0}},theme:"bubble",formats:["background","bold","color","italic","link","strike","underline","header","indent","timestamp"]}),document.getElementById("toolbar-container").style.display="block"}getLeafInfo(e){if(!e&&0!==e)throw"index not valid";let[t,n]=this.quill.getLeaf(e);if(!t)return{};let i=e-n,r=t.domNode.length||null;return{blot:t,offsetFromStart:n,index:i,length:r,text:t.text||"",formats:this.quill.getFormat(i,r)||{}}}getLeafsInfo(e,t){let n=[this.getLeafInfo(e)];for(;n[n.length-1].index+n[n.length-1].length<=e+t;)n.push(this.getLeafInfo(n[n.length-1].index+n[n.length-1].length+1));return n}getLineInfo(e){let[t,n]=this.quill.getLine(e),i=t.cache.length;if(!i)throw"length unavailable";return{blot:t,offsetFromStart:n,index:e-n,endIndex:e-n+i,length:i}}getBlotIndex(e){return e.children?this.getBlotIndex(e.children.head):this.quill.getIndex(e)}invertDelta(e,t){const n=new Delta;return e.reduce((e,i)=>{if(i.insert)n.delete(this.getOpLength(i));else{if(i.retain&&null==i.attributes)return n.retain(i.retain),e+i.retain;if(i.delete||i.retain&&i.attributes){const r=i.delete||i.retain;return t.slice(e,e+r).forEach(e=>{i.delete?n.push(e):i.retain&&i.attributes&&n.retain(this.getOpLength(e),this.invertAttributes(i.attributes,e.attributes))}),e+r}}return e},0),n.chop()}invertAttributes(e,t){e=e||{};const n=Object.keys(t).reduce((n,i)=>(t[i]!==e[i]&&void 0!==e[i]&&(n[i]=t[i]),n),{});return Object.keys(e).reduce((n,i)=>(e[i]!==t[i]&&void 0===t[i]&&(n[i]=null),n),n)}getOpLength(e){return"number"==typeof e.delete?e.delete:"number"==typeof e.retain?e.retain:"string"==typeof e.insert?e.insert.length:1}getAffectedOps(e,t){let n=0,i=t.ops.map(e=>{let t=n;if(n+=e.insert.length,/[\r\n]/.test(e.insert)){let n=[];for(let i=0;i<=e.insert.length-1;i++)n.push(t+i);return n}return t}).flat();i=[0].concat(i,[n]);let r=0,l=[];return e.ops.forEach(e=>{if(e.retain&&(e.attributes&&l.push(this.getLeafInfo(r+1)),r+=e.retain),e.insert){let t=this.getLeafInfo(r+1);if(i.includes(r))"\n"!==e.insert&&l.push(t);else{let n=this.getLeafInfo(r),i=this.getLeafInfo(r+1+e.insert.length);n.index!=t.index&&l.push(n),l.push(t),i.index!=t.index&&l.push(i)}r+=e.insert.length}if(e.delete)if(i.includes(r+e.delete)){if(!i.includes(r)){let e=this.getLeafInfo(r);l.push(e)}}else{let t=i.findIndex(e=>e>r);if(e.delete>i[t]-r){let e=this.getLeafInfo(r);l.push(e)}let n=this.getLeafInfo(r+1);l.push(n)}}),utils.removeDuplicateObjects(l,"index")}}const editorInstance=new Editor;editorInstance.init();export default editorInstance;